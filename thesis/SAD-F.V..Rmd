---
title: "Statistica e Analisi dei Dati"
author: "Francesco Vicidomini"
date: "28/7/2019"
output: 
    pdf_document: 
        toc: yes
---

```{r setup, include=FALSE}
library(readxl)
library(knitr)
library(randomcoloR)
library(plyr)
library(TeachingDemos)
source("../scripts/utils.R")
source("https://raw.githubusercontent.com/talgalili/R-code-snippets/master/boxplot.with.outlier.label.r")

knitr::opts_chunk$set(echo = TRUE)
```
<!--numerazione dell'inidice-->
\setcounter{page}{1} 		
\pagenumbering{roman} 
<!--\listoftables-->
\listoffigures
\newpage
<!--numerazione della tesina -->
\setcounter{page}{1} 		
\pagenumbering{arabic} 
# 1. Introduzione
L'obiettivo del progetto è quello di analizzare e confrontare il numero di laureati(delle università pubbliche) fra le varie regioni italiane nell'anno 2016, i dati sono stati presi dal sito _[dati.istat](http://dati.istat.it/)_ in formato xlsx e sono stati importati in R utilizzando la funzione **read_excel** dopodichè le informazioni delle colonne del dataset vengono salvate nelle  seguenti variabili 
```{r}
ds <- read_excel("../dataset/dataset.xlsx", 
                 skip = 1)

```

Una volta importato il dataset essopresenta i segenti valori  
\begin{figure}[h]
\begin{center}
\includegraphics[width=350px]{../img/ds.png}
\caption{Il dataset}
\end{center}
\end{figure}

Per semplificare il lavoro i valori delle colonne vengono salvati all'interno delle variabili riportate di seguito
```{r}
#variabili
regioni <- c("Piemonte", "Valle d'Aosta", "Liguria", "Lombardia",
             "T. Alto Adige", "Veneto", "F.V.Giulia", "E. Romagna",
             "Toscana", "Umbria", "Marche", "Lazio", "Abruzzo",
             "Molise", "Compania", "Puglia", "Basilicata",
             "Calabria", "Sicilia", "Sardegna")
row.names(ds) <- regioni
triennale <- ds$`corsi di laurea di I livello`
magistrale <- ds$`corsi di laurea magistrale biennale`
unico <- ds$`corsi di laurea magistrale a ciclo unico`
vecchio <- ds$`corsi di laurea del vecchio ordinamento`
```

## 1.1 Calcolo dei tassi
I valori risultano molto altalenanti, quindi potrebbero risultare difficili da rappresentare graficamente in futuro, per ovviare a questo problema si è pensato di rappresentare i dati come tasso di laureati per regione ogni mille abitanti, i valori sono stati poi arrotondati alle sole prime tre cifre decimale, il dataset dopo la trasformazione si presenta nel seguente modo:

\begin{figure}[h]
\begin{center}
\includegraphics[width=450px]{../img/dsTassi.png}
\caption{Tasso di laureati ogni mille abitanti}
\end{center}
\end{figure}

I valori sono stati calcolati utilizzando i seguenti comandi:

```{r}
popolazione <- c(4404000, 127329, 1571000, 10010000,
                 1062860, 4915000, 1221000, 4448000,
                 3744000, 891181, 1544000, 5888000, 
                 1327000, 312027, 5851000, 4077000,
                 573694, 1971000, 5074000, 1658000)
tassoTriennale <- (triennale / popolazione) * 1000
tassoMagistrale <- (magistrale / popolazione) * 1000
tassoUnico <- (unico / popolazione) * 1000
tassoVecchio <- (vecchio / popolazione) * 1000
dsTassi <- data.frame("Tasso laureati triennali"=round(tassoTriennale, digits = 3),
                      "Tasso laureati magistrali"=round(tassoMagistrale, digits = 3),
                      "Tasso laureati a ciclo unico"=round(tassoUnico, digits = 3),
                      "Tasso laureati vecchio ordinamento"=round(tassoVecchio, digits = 3)
                     )
dsPopolazione <- data.frame("Popolazione"= popolazione)
row.names(dsPopolazione) <- regioni
row.names(dsTassi) <- regioni

```

Nel data frame **dsPopolazione** sono presenti il numero di abitanti di ogni regione italiana nell'anno 2016; nel data frame **dsTassi** sono presenti i tassi di laureati per ogni regioni italiana per ogni tipo di laurea e anche il totale dei tassi.

# 2. Grafici a barre
Per una rapida visualizzazione dei dati si è deciso di mostrare i grafici a barre dei laureati nelle varie regioni d'Italia. I grafici verranno mostrati con la funzione scritta ad hoc **showBar**
```{r}
showBar
```
essa prende in input un dei vettori dei tassi, i nomi delle regioni per definire le label della legenda, il nome del grafico e il numero di righe del dataframe, i colori delle barre sono stati definiti grazie alla funzione **distinctColorPalette** della libreria **randomcoloR**.

## 2.1 Grafico dei tassi dei laureati triennali
```{r}
rowTassi <- nrow(dsTassi)
showBar(tassoTriennale, regioni, "Tassi Triennale", rowTassi, "topleft")
```

Il grafico ci dice che la regione con il più alto tasso di laureati triennali è l'Abruzzo(4.5) mentre la regione con il tasso più basso è la Basilicata(0.88).

## 2.2 Grafico dei tassi dei laureati magistrali
```{r}
showBar(tassoMagistrale, regioni, "Tassi Magistrale", rowTassi, "topright")
```

I tassi per i laureati magistrali si abbassano, questo è normale perchè bisogna considare il fatto che la popolazione resta sempre la stessa ma il numero di laureati Magistrali è molto più basso rispetto a quello dei laureati triennali.  
Il tasso più alto viene registrato in Emilia-Romagna(2.01), l'Abruzzo che aveva il più alto tasso di laureati Triennali continua ad avere un tasso abbastanza alto pari a 1.88, il tasso più basso viene registrato dalla Valle d'Aosta con un tasso di laureati magistrali pari a 0.09.

## 2.3 Grafico dei tassi dei laureati a ciclo unico
```{r}
showBar(tassoUnico, regioni, "Tassi ciclo unico", rowTassi,"topleft")
```

Anche in questo caso i tassi si abbassano ulteriormente dato che i laureati a ciclo unico per ogni regione sono molto meno rispetto a laureati Triennali e Magistrali.  
La regione con il tasso più alto è di nuovo l'Abruzzo con 0.93 mentre la regione con il tasso più basso è la Valle d'Aosta con 0.02.

## 2.4 Grafico dei tassi dei laureati con il vecchio ordinamento
```{r}
showBar(tassoVecchio, regioni, "Tasso vecchio ordinamento", rowTassi, "topright")
```
Per i laureati registramo i tassi più bassi di tutti dato che il numero di totale di laureati con il vecchio ordinamento in Italia nel 2016 è pari a 2727. La regione con il tasso più alto resta l'Abruzzo con 0.10, il tasso più basso si registra in Umbria avente un tasso pari a 0.

# 3. Diagramma di Pareto
La legge del Principio di Pareto(Legge dell'80/20) afferma che _"la maggior parte degli effetti dipendono da un numero ristretto di cause"_. Per costruire il diagramma di Pareto occorre classificare i dati, ordinarli, disegnare un grafico a barre, aggiungere la linea cumulativa e aggiungere le informazioni di base.  
Come dati da classificare è stato scelto il totale dei tassi di laureti italiani, di seguito viene mostrata la funzione utilizzata per costruire il diagramma.
```{r eval=FALSE, echo=TRUE}
showPareto <- function(totale, main, rows){
    #ordiniamo il dataset
    ordinato <- dsTassi[order(dsTassi$Totale, decreasing = TRUE),]
    #prendiamo le regioni ordinate
    lbls <- rownames(ordinato)
    #prendiamo il totale
    ordinato <- ordinato$Totale
    freqRel <- prop.table(ordinato)
    app <- data.frame(ordinato)
    pal<- distinctColorPalette(rows)
    x<- barplot(freqRel, ylim= c(0, 1.5), main = main, col=pal, axisname = FALSE)
    axis(1, las=2, hadj= 0.6, at=x, labels=lbls, line=1, col="transparent")
    lines(x, cumsum(freqRel), type = "b", pch=16)
    text(x-0.2, cumsum(freqRel) + 0.03, paste(format(cumsum(freqRel)*100, digits = 3), "%"))
}

showPareto(totaleTassi, "Diagramma di Pareto di tutti i laureati nel 2016", rowTassi)
```
\newpage
\begin{figure}[t]
\includegraphics{../img/pareto.png}
\caption{Pareto dei laureati italiani}
\end{figure}
Dal grafico si evince che:

- l'8.56% dei laureati italiani è abruzzese
- il 75.89% dei laureati italiani è abruzzese, romagnolo, laziale, marchigiano, umbro, friulano, toscano, campano, veneto, piemontese, molisano, alto adesino, lombardo
- il 15,55% dei laureati italiani vive nelle restanti sette regioni
Possiamo dire che il principio di Pareto non è soddisfatto perchè l'80% dei laureati esce dal più del 50% delle università sparse per le varie regioni(invece che nel 20%).

# 4. Retta di regressione
La relazione fra due variabili quantitative può essere rappresentata graficamente con un diagramma di dispessione(anche detto scatterplot). Per poter costruire questo grafico abbiamo bisogno di individuare le due variabili da mettere in relazione, la coppia di variabili è formata da una variabile **dipendente**(posta sull'asse delle Y) e una **indipendente**(posta sull'asse delle X); ogni coppia di osservazioni viene rappresentata come un punto. Il risultato finale sarà un grafico contenente un insieme di punti attraverso il quale cerchiamo di individuare un trend.  
La correlazione tra le variabili quantitative si ricava tramite la **covarianza** che indica quanto le due variabili variano insieme, ovvero quanto esse siano dipendenti.  
Il **coefficiente di correlazione** ci consente di misurare la "forza" del legame fra le due variabili prese in esame.  
Le variabili prese in esame sono:

- tasso di laureati magistrali dipendente
- tasso di laureati triennali indipendente

Le due variabili presentano una **covarianza** pari a 
```{r echo=TRUE, eval=TRUE}
cov(tassoTriennale, tassoMagistrale)
```
e un **coefficiente di correlazione** pari a 
```{r echo=TRUE, eval=TRUE}
cor(tassoTriennale, tassoMagistrale)
```
Possiamo notare che la covarianza è positiva quindi possiamo dire che i valori delle due variabili sono correlati e che tendono a variare insieme, anche il coefficiente di correlazione è positivo e assume un valore molto prossimo ad 1 questo ci da una ulteriore conferma della bontà di questo legame.

## 4.1 Regressione lineare semplice
Il modello di regressione lineare semplice è esprimibile attraverso l'equazione di una retta tale da riuscire a interpolare i punti della nuvola dello scatterplot meglio di tutte le altre rette possibili.  
L'equazione della retta è:
$$Y =  \alpha + \beta X$$
Dove alpha è l'**intercetta** e beta il **coefficiente angolare**.  
L'intercetta corrisponde all'ordinata del punto di intersezione tra la retta interpolante e l'asse delle ordinate. Il coefficiente angolare indica la pendenza della retta un coefficiente positivo indica una retta crescente, mentre, un coefficiente angolare negativo indica una retta descrescente. 

## 4.2 Costruzione del modello di regressione lineare semplice
```{r echo=TRUE, eval=TRUE}
slr <- lm(tassoTriennale~tassoMagistrale)
print(slr)
```
Possiamo notare che il coefficiente angolare è positivo quindi avremo una retta crescente.  
Di seguito viene mostrato lo script fatto per mostrare lo scatterplot della retta di regressione, per una migliore visualizzazione i dati riguardanti i tassi triennali e magistrali sono stati scalati utilizzando la funzione **scale()**.
```{r echo=TRUE, eval=TRUE}
scaleTriennale <- scale(tassoTriennale)
scaleMagistrale <- scale(tassoMagistrale)
modelloScalato <- lm(scaleTriennale~scaleMagistrale)
plot(scaleTriennale, scaleMagistrale, main= "Retta di regressione", xlab="tasso Triennale",
ylab = "tasso Magistrale", col="red")
abline(modelloScalato)
stime <- fitted(modelloScalato)
segments(scaleTriennale, stime, scaleTriennale, scaleMagistrale, col="magenta")
text(x=scaleTriennale, y=scaleMagistrale, label = regioni, cex = 0.6)
```

Dal grafico si evince che il campione è positivamente correlato in quanto abbiamo una retta interpolante crescente e che avendo una covarianza positiva ma non di molto i segmenti non presentano sempre la stessa distanza.

## 4.3 Grafico dei residui
Con l'analisi dei residui effettuiamo una analisi più accurata sul come la retta interpola i dati e di come i residui si dispongono intorno alla retta interpolante influenzandone la posizione. I residui sono posti sulle ordinate mentre e i valori della variabile indipendente sono disposti sull'asse delle ascisse.  
Come prima cosa vengono calcolati i residui del modello con la funzione **resid()** dopodichè viene stampato il grafico dei residui
```{r echo=TRUE, eval=TRUE}
residui<-(resid(slr))
plot(tassoMagistrale, residui, main = "Grafico dei residui", xlab = "Tasso Magistrale",
ylab = "Residui", col= "red")
text(x= tassoMagistrale, y=residui+0.05, labels = regioni, cex=0.6)
abline(h=0, col="blue", lty=2)
```

# 5. Statistica descrcittiva

## 5.1 Quantile
La funzione **quantile()** è utile per analizzare un campione di dati, essa restituisce cinque valori:

- Q0 valore minimo dei dati
- Q1 primo quantile, questo valore corrisponde al dato per il quale il 25% dei dati risultano alla sinistra del valore e il 75% risulta a destra
- Q2 secondo quantile, questo valore corrisponde al dato per il quale il 50% dei dati risultano alla sinistra del valore e il 50% risulta a destra; questo valore viene anche chiamato **mediana**
- Q3 terzo quantile, questo valore corrisponde al dato per il quale il 75% dei dati risultano alla sinistra del valore e il 25% risulta a destra
- Q4 valore massimo dei dati

## 5.2 Calcolo dei quantili
In questo paragrafo verranno calcolati i quantili per le varie colonne del dataset dei tassi, i valori percentiali corrispondono ai seguenti quantili:

- 0% sta a Q0
- 25% sta a Q1
- 50% sta a Q2
- 75% sta a Q3
- 100% sta a Q4

```{r echo = TRUE, eval = TRUE}
quantile(tassoTriennale)
quantile(tassoMagistrale)
quantile(tassoUnico)
quantile(tassoVecchio)
```

## 5.3 Boxplot
Con il boxplot andiamo a rappresentare graficamente quanto è stato calcolato con in quantili. La rappresentazione grafica corrisponde ad una scatola i cui estremi corrispondono a Q1 e Q3, e da una linea centrale che rappresenta Q2, in alto e in basso sono presenti due linee orizzontali dette "baffi".  
Il baffo inferiore corrisponde al valore più piccolo delle osservazioni Q0
$$Q_0 >= Q_1-1.5*(Q_3-Q_1)$$
il baffo superiore corrisponde al valore più alto delle osservazioni(Q4) 
$$Q_4 <= Q_3+1.5*(Q_3-Q_1)$$
Se tutti i dati rientrano nell'intervallo
$$ Q_1-1.5*(Q_3-Q_1) <= x <= Q_3+1.5*(Q_3-Q_1)$$
allora i baffi saranno posti in corrispondenza del valore minimo e del valore massimo del campione, se invece sono presenti valori al di fuori dell'intervallo questi verranno considerati come valori anomomali(**outlier**) i valori anomali vanno comunque analizzati per capire da cosa è stato scaturito quel valore anomalo.
Il boxplot può essere utilizzato anche per esaminare altre caratteristiche della distribuzione quali:

- **centralità** espressa come mediana
- **forma** la forma che può assumere può essere simmatrica o asimmetrica essa può essere dedotta esaminando le distanza tra il primo e il terzo quartile
- **dispersione** possiamo dedurre la dispersione esaminando la distanza che passa da Q1 a Q3  

Per mostrare i boxplot è stata sviluppata la funzione **showBarPlot**
```{r, eval=FALSE}
showBoxPlot <- function(label, tasso, name, title, color, lim){
    boxplot.with.outlier.label(label_name = label, tasso,
    names=c(name), main=title,
    col= color, pars=list(ylim=c(0,lim)))
}
#esempio di chiamata della funzione
showBoxPlot(regioni, tassoTriennale, "Tasso Triennale",
            "Boxplot tasso laureati triennali", "green", 5)
showBoxPlot(regioni, tassoMagistrale, "Tasso Magistrale",
            "Boxplot tasso laureati magistrali", "yellow", 3)
showBoxPlot(regioni, tassoUnico, "Tasso Ciclo Unico",
            "Boxplot tasso laureati ciclo unico", "blue", 2)
showBoxPlot(regioni, tassoVecchio, "Tasso Vecchio Ordinamento",
            "Boxplot tasso laureati vecchio ordinamento", "purple", 0.3)
```

La funzione showBar per disegnare i boxplot con le label usa la funziona **boxplot.with.outlier.label** presa da __\href{https://raw.githubusercontent.com/talgalili/R-code-snippets/master/boxplot.with.outlier.label.r}{questo repository}__.  
Showbar prende in input:

* le label che sarebbero le regioni,
* la colonna dei tassi,
* il nome della colonna,
* titolo da dare al boxplot,
* colore del box,
* lunghezza dell'asse y


\begin{figure}[h]
\begin{center}
\includegraphics{../img/boxplot.png}
\caption{Boxplot dei laureati}
\end{center}
\end{figure}

## 5.4 Analisi del boxplot
Analizzando il boxplot possiamo arrivare alle seguenti conclusioni:

* l'unico outlier è presente nella colonna dei tassi triennali ed è la regione Abruzzo con 4.5
* i dati risultano avare una maggiore dispersione nella colonna dei laureati triennali
* possiamo notare la compattezza dei dati relativi alle colonne del tasso dei laureati a ciclo unico e del tasso dei laureati con vecchio ordinamento
* per i laureati magistrali la maggior parte dei dati si trova alla sinistra della mediana
